<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Manager GS - Secure Auth</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body { background-color: #f4f6f9; overflow-x: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { display: flex; min-height: 100vh; width: 100%; }
        .sidebar { background-color: #212529; color: white; display: flex; flex-direction: column; transition: all 0.3s; width: 15%; min-width: 200px; flex-shrink: 0; }
        .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 12px 15px; border-radius: 5px; margin-bottom: 5px; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background-color: #0d6efd; }
        .sidebar .nav-link i { margin-right: 10px; font-size: 1.1rem; }
        .main-content { flex-grow: 1; padding: 25px 25px 5px 25px; width: 85%; overflow-y: hidden; height: 100vh; display: flex; flex-direction: column; }
        @media (max-width: 992px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 260px; z-index: 1060; transform: translateX(-100%); box-shadow: 4px 0 15px rgba(0,0,0,0.5); }
            .sidebar.show { transform: translateX(0); }
            .main-content { width: 100%; padding: 70px 10px 10px 10px; overflow-y: auto; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; }
            .overlay.show { display: block; }
            .mobile-nav { display: flex; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            #mapContainer { height: 50vh !important; min-height: 350px; }
            .excel-table th, .excel-table td { font-size: 0.75rem; padding: 6px 8px; }
        }
        @media (max-width: 576px) { .login-box { width: 95%; padding: 1.5rem; } }
        .mobile-nav { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: #212529; color: white; z-index: 1055; padding: 0 20px; align-items: center; justify-content: space-between; }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 2.5rem; border-radius: 12px; width: 400px; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .excel-view-container { overflow: auto; white-space: nowrap; border: 1px solid #dee2e6; background: white; padding-bottom: 5px; display: flex; flex-direction: column; height: 100%; -webkit-overflow-scrolling: touch; }
        .table-fix-height { flex-grow: 1; overflow: auto; }
        .excel-table th, .excel-table td { padding: 8px 12px; border: 1px solid #dee2e6; font-size: 0.85rem; vertical-align: middle; }
        .excel-table th { background-color: #343a40; color: white; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; position: sticky; top: 0; z-index: 10; }
        .header-filter { width: 100%; margin-top: 5px; padding: 2px 4px; font-size: 0.7rem; border: 1px solid #ced4da; border-radius: 2px; color: #000; }
        .editable-cell { cursor: pointer; transition: background 0.2s; }
        .editable-cell:hover { background-color: #fff3cd; }
        .editable-cell:focus { background-color: #fff; outline: 2px solid #0d6efd; padding: 8px 12px; z-index: 5; }
        .view-section { display: none; height: calc(100% - 30px); overflow-y: auto; padding-right: 5px; }
        .active-view { display: block; }
        .table-footer { position: sticky; bottom: 0; background-color: #e9ecef; font-weight: bold; z-index: 10; border-top: 2px solid #343a40; }
        .grand-total-box { background-color: #198754; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; }
        .app-footer { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #6c757d; font-weight: 500; }
        #mapContainer { z-index: 1; border: 1px solid #ddd; border-radius: 4px; }
        .checkbox-container { max-height: 120px; overflow-y: auto; border: 1px solid #dee2e6; background: white; padding: 5px; border-radius: 4px; }
        .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
        .report-cell-warn { background-color: #fff3cd !important; color: #856404; }
        .report-cell-empty { color: #ccc; }
        #criticalErrorAlert { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .google-btn { background-color: #DB4437; color: white; transition: 0.3s; }
        .google-btn:hover { background-color: #c53929; color: white; }
    </style>
</head>
<body>

    <div id="criticalErrorAlert" class="alert alert-danger border-danger">
        <h5 class="alert-heading fw-bold"><i class="bi bi-exclamation-octagon-fill"></i> Errore Critico Database</h5>
        <p class="mb-0 small">Impossibile leggere i dati. Verifica la connessione o i permessi.</p>
    </div>

    <div class="modal fade" id="modalEditUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-person-gear"></i> Mappa Utente Auth</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditUser">
                        <input type="hidden" id="editUserKey">
                        <div class="alert alert-info small">
                            Incolla qui l'email usata per l'accesso Firebase per assegnare Ruoli e Account.
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Email (Firebase Auth)</label>
                            <input type="text" id="editUserEmail" class="form-control" placeholder="nome.cognome@..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Nome Account (Visualizzato)</label>
                            <input type="text" id="editUserAcc" class="form-control" placeholder="Es. Rossi Mario" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Ruolo</label>
                            <select id="editUserRole" class="form-select">
                                <option value="USER">User (Standard)</option>
                                <option value="ADMIN">ADMIN (Completo)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="window.saveUserAdmin()">Salva Mappatura</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditOrdine" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> Modifica Ordine</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><form id="formEditOrdine"><input type="hidden" id="editKey"><div class="row g-2 mb-3"><div class="col-md-3 col-12"><label class="small fw-bold">Data Ordine</label><input type="date" id="editData" class="form-control"></div><div class="col-md-3 col-12"><label class="small fw-bold">SAP</label><input type="text" id="editSap" class="form-control"></div><div class="col-md-6 col-12"><label class="small fw-bold">Cliente</label><input type="text" id="editCliente" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-4 col-12"><label class="small fw-bold">Account</label><input type="text" id="editAccount" list="listAccounts" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold text-danger">Ordine AP</label><input type="text" id="editOrdineAP" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold">Stato</label><select id="editStato" class="form-select"></select></div></div><div class="row g-2 mb-3"><div class="col-md-6 col-12"><label class="small fw-bold">Descrizione</label><input type="text" id="editDesc" list="listDesc" class="form-control"></div><div class="col-md-6 col-12"><label class="small fw-bold">Note</label><input type="text" id="editNote" class="form-control"></div></div><div class="row g-2 mb-3 align-items-end"><div class="col-md-3 col-6"><label class="small fw-bold">WKI_m</label><input type="number" step="0.01" id="editWki" class="form-control"></div><div class="col-md-3 col-6"><label class="small fw-bold">M365_m</label><input type="number" step="0.01" id="editM365" class="form-control"></div><div class="col-md-3 col-6"><label class="small fw-bold">Una Tantum</label><input type="number" step="0.01" id="editUna" class="form-control"></div><div class="col-md-3 col-6"><label class="small fw-bold">1° Fattura</label><input type="date" id="editDataFatt" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="button" class="btn btn-primary fw-bold" onclick="window.saveEditOrdine()">SALVA MODIFICHE</button></div></div></div></div>
    <div class="modal fade" id="modalEditCliente" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold"><i class="bi bi-person-badge"></i> Gestione Cliente</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><form id="formEditCliente"><input type="hidden" id="cliKey"><div class="row g-2 mb-3"><div class="col-md-3 col-6"><label class="small fw-bold">SAP</label><input type="text" id="cliSap" class="form-control"></div><div class="col-md-6 col-12"><label class="small fw-bold">Nome / Ragione Sociale</label><input type="text" id="cliNome" class="form-control"></div><div class="col-md-3 col-6"><label class="small fw-bold">Partita IVA</label><input type="text" id="cliPiva" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-4 col-12"><label class="small fw-bold">Account</label><input type="text" id="cliAccount" list="listAccounts" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold">Cod. Fiscale</label><input type="text" id="cliSwOa" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold">Telefono</label><input type="text" id="cliTel" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-6 col-12"><label class="small fw-bold">Via e Numero</label><input type="text" id="cliVia" class="form-control"></div><div class="col-md-4 col-8"><label class="small fw-bold">Città</label><input type="text" id="cliCitta" class="form-control"></div><div class="col-md-2 col-4"><label class="small fw-bold">Prov</label><input type="text" id="cliProv" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-6 col-12"><label class="small fw-bold">Email</label><input type="text" id="cliEmail" class="form-control"></div><div class="col-md-6 col-12"><label class="small fw-bold">Note</label><input type="text" id="cliNote" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="button" class="btn btn-primary fw-bold" onclick="window.saveCliente()">SALVA CLIENTE</button></div></div></div></div>
    <div class="modal fade" id="modalEditContratto" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title fw-bold"><i class="bi bi-file-text"></i> Gestione Contratto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><form id="formEditContratto"><input type="hidden" id="conKey"><div class="row g-2 mb-3"><div class="col-md-3 col-6"><label class="small fw-bold">SAP</label><input type="text" id="conSap" class="form-control"></div><div class="col-md-5 col-12"><label class="small fw-bold">Cliente (Nome)</label><input type="text" id="conNome" class="form-control"></div><div class="col-md-4 col-6"><label class="small fw-bold">Account</label><input type="text" id="conAccount" list="listAccounts" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-4 col-12"><label class="small fw-bold">Codice Sistema</label><input type="text" id="conSistema" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold">Codice Listino</label><input type="text" id="conCodice" class="form-control"></div><div class="col-md-4 col-12"><label class="small fw-bold">Pagamento</label><input type="text" id="conPagamento" class="form-control"></div></div><div class="row g-2 mb-3"><div class="col-md-8 col-12"><label class="small fw-bold">Testo Ordine / Prodotto</label><input type="text" id="conTesto" class="form-control"></div><div class="col-md-2 col-6"><label class="small fw-bold">Q.tà</label><input type="number" id="conQta" class="form-control"></div><div class="col-md-2 col-6"><label class="small fw-bold">Passo</label><input type="text" id="conPasso" class="form-control"></div></div><div class="row g-2 mb-3 align-items-end"><div class="col-md-4 col-12"><label class="small fw-bold">Data Scadenza</label><input type="date" id="conScadenza" class="form-control"></div><div class="col-md-4 col-6"><label class="small fw-bold text-primary">Valore Rinnovo</label><input type="number" step="0.01" id="conValRinnovo" class="form-control"></div><div class="col-md-4 col-6"><label class="small fw-bold text-info">Val. Unit. Mensile</label><input type="number" step="0.01" id="conValMensile" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="button" class="btn btn-primary fw-bold" onclick="window.saveContratto()">SALVA CONTRATTO</button></div></div></div></div>
    <div class="modal fade" id="modalEditMigrazione" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold"><i class="bi bi-airplane-engines"></i> Modifica Migrazione</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><form id="formEditMigrazione"><input type="hidden" id="editMigrKey"><div class="mb-3"><label class="small fw-bold">Cliente</label><input type="text" id="editMigrCliente" class="form-control bg-white" readonly></div><div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold">Data Prevista</label><input type="date" id="editMigrData" class="form-control"></div><div class="col-6"><label class="small fw-bold">Stato</label><select id="editMigrStato" class="form-select"><option value="Prevista">Prevista</option><option value="Sospesa">Sospesa</option><option value="Pianificata">Pianificata</option><option value="Altro">Altro</option></select></div></div><div class="mb-3"><label class="small fw-bold">Note / Appunti</label><textarea id="editMigrNote" class="form-control" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="button" class="btn btn-primary fw-bold" onclick="window.saveEditMigrazione()">SALVA MODIFICHE</button></div></div></div></div>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h3 class="text-center mb-4 fw-bold text-primary">Flow Manager GS</h3>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="username" class="form-control" placeholder="nome@azienda.com">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Password">
            </div>
            <div class="d-grid mb-3">
                <button class="btn btn-primary btn-lg" onclick="window.appLogin()">
                    Accedi con Email
                </button>
            </div>
            
            <div class="text-center mb-2">
                <span class="text-muted small">oppure</span>
            </div>

            <div class="d-grid mb-3">
                <button class="btn google-btn btn-lg" onclick="window.loginGoogle()">
                    <i class="bi bi-google"></i> Accedi con Google
                </button>
            </div>

            <div class="text-center mt-3 text-muted small">Accesso Riservato</div>
            <div class="text-center mt-2 text-muted" style="font-size: 0.75rem;">© • GS 2026</div>
        </div>
    </div>

    <div class="mobile-nav">
        <span class="fw-bold">Flow Manager GS</span>
        <button class="btn btn-outline-light btn-sm" onclick="window.toggleSidebar()"><i class="bi bi-list"></i> Menu</button>
    </div>
    <div id="sidebarOverlay" class="overlay" onclick="window.toggleSidebar()"></div>

    <div id="mainApp" class="app-container" style="display: none !important;">
        <nav id="sidebar" class="sidebar p-3">
            <div class="mb-4 d-none d-lg-block">
                <h5 class="text-white mb-0">Flow Manager GS</h5>
                <small class="text-muted">Wolters Kluwer</small>
            </div>
            <div class="mb-4 pb-3 border-bottom border-secondary">
                <div class="d-flex align-items-center text-white text-decoration-none">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div style="overflow: hidden;">
                        <div class="fw-bold text-truncate" id="userDisplay" style="font-size: 0.85rem;">Utente</div>
                        <small class="text-muted" id="userEmailDisplay" style="font-size:0.7rem;"></small>
                    </div>
                </div>
            </div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item"><a class="nav-link active" id="nav-home" onclick="window.navigate('home')"><i class="bi bi-person-vcard"></i> Scheda Cliente</a></li>
                <li><a class="nav-link" id="nav-fatturato" onclick="window.navigate('fatturato')"><i class="bi bi-currency-euro"></i> Fatturato (Ordini)</a></li>
                <li><a class="nav-link" id="nav-clienti" onclick="window.navigate('clienti')"><i class="bi bi-people"></i> Elenco Clienti</a></li>
                <li><a class="nav-link" id="nav-contratti" onclick="window.navigate('contratti')"><i class="bi bi-file-earmark-text"></i> Elenco Contratti</a></li>
                <li><a class="nav-link" id="nav-migrazioni" onclick="window.navigate('migrazioni')"><i class="bi bi-airplane-engines"></i> Piano Migrazioni</a></li>
                <li><a class="nav-link" id="nav-report-migrazioni" onclick="window.navigate('report-migrazioni')"><i class="bi bi-calendar3"></i> Report Annuale</a></li>
                <li><a class="nav-link" id="nav-statistiche" onclick="window.navigate('statistiche')"><i class="bi bi-geo-alt-fill"></i> Statistiche Mappa</a></li>
                <li class="mt-4 border-top border-secondary pt-2" id="nav-item-strumenti" style="display:none;">
                    <a class="nav-link text-warning" id="nav-strumenti" onclick="window.navigate('strumenti')"><i class="bi bi-database-gear"></i> Strumenti DB</a>
                </li>
            </ul>
            <div class="mt-auto pt-3 border-top border-secondary">
                <button class="btn btn-outline-danger w-100 btn-sm" onclick="window.appLogout()"><i class="bi bi-box-arrow-left"></i> Esci</button>
            </div>
        </nav>

        <main class="main-content">
            <div id="view-home" class="view-section active-view">
                <h3 class="mb-4">Scheda Cliente & Nuovo Ordine</h3>
                <div class="card mb-4 border-primary shadow-sm">
                    <div class="card-body bg-light">
                        <div class="row align-items-end">
                            <div class="col-md-8 col-12 mb-2">
                                <label class="form-label fw-bold text-primary">CERCA CLIENTE</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                    <input type="text" list="clientListOptions" id="searchInput" class="form-control form-control-lg" placeholder="Digita SAP o Nome Cliente..." onchange="window.caricaScheda()">
                                    <datalist id="clientListOptions"></datalist>
                                </div>
                            </div>
                            <div class="col-md-4 col-12 mt-2 mt-md-0"><button class="btn btn-primary btn-lg w-100" onclick="window.caricaScheda()">Carica Scheda</button></div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4 shadow-sm" id="cardDatiCompleti" style="display:none;">
                    <div class="card-header bg-primary text-white fw-bold">DATI ANAGRAFICI</div>
                    <div class="card-body p-0"><div class="excel-view-container"><table class="table mb-0 excel-table" id="tabellaExcelHome"></table></div></div>
                </div>
                <div class="card mb-4 shadow border-success" id="cardNuovoOrdine" style="display:none;">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center"><span class="fw-bold"><i class="bi bi-plus-circle"></i> NUOVO ORDINE</span></div>
                    <div class="card-body bg-light">
                        <form id="formOrdine" onsubmit="event.preventDefault(); window.registraOrdine();">
                            <div class="row g-2 mb-2"><div class="col-md-2 col-6"><label class="small fw-bold">Data Ordine</label><input type="date" id="ordData" class="form-control form-control-sm" required></div><div class="col-md-2 col-6"><label class="small fw-bold">SAP</label><input type="text" id="ordSap" class="form-control form-control-sm" readonly style="background-color: #e9ecef;"></div><div class="col-md-4 col-12"><label class="small fw-bold">Cliente</label><input type="text" id="ordCliente" class="form-control form-control-sm" readonly style="background-color: #e9ecef;"></div><div class="col-md-4 col-12"><label class="small fw-bold">Account</label><input type="text" id="ordAccount" list="listAccounts" class="form-control form-control-sm" placeholder="Seleziona o scrivi..."><datalist id="listAccounts"></datalist></div></div>
                            <div class="row g-2 mb-2"><div class="col-md-4 col-12"><label class="small fw-bold">Descrizione Ordine</label><input type="text" id="ordDesc" list="listDesc" class="form-control form-control-sm" placeholder="Seleziona operazione..."><datalist id="listDesc"></datalist></div><div class="col-md-8 col-12"><label class="small fw-bold">Note</label><input type="text" id="ordNote" class="form-control form-control-sm" placeholder="Note aggiuntive..."></div></div>
                            <div class="row g-2 mb-3 align-items-end"><div class="col-md-1 col-4"><label class="small fw-bold text-primary">WKI_m</label><input type="number" step="0.01" id="ordWkiMese" class="form-control form-control-sm" placeholder="0.0"></div><div class="col-md-1 col-4"><label class="small fw-bold text-info">M365_m</label><input type="number" step="0.01" id="ordM365Mese" class="form-control form-control-sm" placeholder="0.0"></div><div class="col-md-1 col-4"><label class="small fw-bold text-warning">Una_T</label><input type="number" step="0.01" id="ordUnaTantum" class="form-control form-control-sm" placeholder="0.0"></div><div class="col-md-2 col-6"><label class="small fw-bold text-danger">Ordine AP</label><input type="text" id="ordOrdineAP" class="form-control form-control-sm" placeholder="Codice AP"></div><div class="col-md-2 col-6"><label class="small fw-bold">Stato</label><select id="ordStato" class="form-select form-select-sm"></select></div><div class="col-md-2 col-6"><label class="small fw-bold">1° Fattura</label><input type="date" id="ordDataFatt" class="form-control form-control-sm"></div><div class="col-md-3 col-12 mt-2"><button type="submit" class="btn btn-success btn-sm w-100 fw-bold shadow"><i class="bi bi-save"></i> REGISTRA</button></div></div>
                        </form>
                    </div>
                </div>
                <div class="card shadow-sm mb-4" id="cardContratti" style="display:none;">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"><span class="fw-bold">CONTRATTI ATTIVI</span><button class="btn btn-light btn-sm fw-bold text-secondary" onclick="window.printContrattiCliente()"><i class="bi bi-printer-fill"></i> STAMPA</button></div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0 font-monospace small"><thead class="table-light"><tr><th>SAP</th><th>Sistema</th><th>Val. Rinnovo</th><th>Val. Unit. Mens.</th><th>Testo Ordine</th><th>Scadenza</th><th>Quantità</th><th>Passo</th><th>Pagamento</th></tr></thead><tbody id="tabellaContrattiBodyHome"></tbody></table></div></div>
                </div>
            </div>

            <div id="view-fatturato" class="view-section">
                <h3 class="mb-3">Registro Fatturato (Ordini)</h3>
                <div class="card shadow-sm h-100"><div class="card-body p-0 h-100 d-flex flex-column"><div class="excel-view-container"><table class="table mb-0 excel-table table-hover" id="tabellaFatturatoReal"><thead><tr><th>Az.</th><th>Data Ord.<input type="text" class="header-filter" onkeyup="window.filterFatturato(1)"></th><th>SAP<input type="text" class="header-filter" onkeyup="window.filterFatturato(2)"></th><th>Cliente<input type="text" class="header-filter" onkeyup="window.filterFatturato(3)"></th><th>Account<input type="text" class="header-filter" onkeyup="window.filterFatturato(4)"></th><th class="text-danger">Ord. AP<input type="text" class="header-filter" onkeyup="window.filterFatturato(5)"></th><th>Descrizione<input type="text" class="header-filter" onkeyup="window.filterFatturato(6)"></th><th>Note<input type="text" class="header-filter" onkeyup="window.filterFatturato(7)"></th><th class="bg-primary bg-opacity-75">WKI_m<input type="text" class="header-filter" onkeyup="window.filterFatturato(8)"></th><th class="bg-info bg-opacity-75">M365_m<input type="text" class="header-filter" onkeyup="window.filterFatturato(9)"></th><th class="bg-warning text-dark bg-opacity-75">Una_Tantum<input type="text" class="header-filter" onkeyup="window.filterFatturato(10)"></th><th>Fin.<input type="text" class="header-filter" onkeyup="window.filterFatturato(11)"></th><th>Stato<input type="text" class="header-filter" onkeyup="window.filterFatturato(12)"></th><th class="text-center bg-secondary text-white">Fatt.</th><th>1° Fatt.<input type="text" class="header-filter" onkeyup="window.filterFatturato(14)"></th><th class="bg-dark text-white">Mesi<input type="text" class="header-filter" onkeyup="window.filterFatturato(15)"></th><th class="bg-dark text-white">Finanziario<input type="text" class="header-filter" onkeyup="window.filterFatturato(16)"></th><th class="bg-dark text-white">UP_WKI_An<input type="text" class="header-filter" onkeyup="window.filterFatturato(17)"></th><th class="bg-dark text-white">UP_M365_An<input type="text" class="header-filter" onkeyup="window.filterFatturato(18)"></th></tr></thead><tbody id="tabellaFatturatoFull"></tbody><tfoot class="table-footer"><tr><td colspan="10" class="text-end">Totali:</td><td id="totUna" class="text-end text-dark bg-warning bg-opacity-25">0.00</td><td colspan="5"></td><td id="totFin" class="text-end bg-light">0.00</td><td id="totWkiAn" class="text-end bg-light">0.00</td><td id="totM365An" class="text-end bg-light">0.00</td></tr><tr style="border-top: none;"><td colspan="18" class="text-end py-2 bg-white"><span class="grand-total-box">TOTALE COMPLESSIVO: € <span id="totGrand">0.00</span></span></td></tr></tfoot></table></div></div></div>
            </div>

            <div id="view-clienti" class="view-section"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="mb-0">Anagrafica Clienti</h3><button id="btnAddCliente" class="btn btn-primary btn-sm fw-bold" style="display:none;" onclick="window.nuovoCliente()"><i class="bi bi-plus-lg"></i> Nuovo Cliente</button></div><div class="card shadow-sm h-100"><div class="card-body p-0 h-100 d-flex flex-column"><div class="excel-view-container table-fix-height"><table class="table mb-0 excel-table table-hover" id="tabellaClientiReal"><thead id="theadClientiFull"></thead><tbody id="tabellaClientiFull"></tbody></table></div></div></div></div>
            <div id="view-contratti" class="view-section"><div class="d-flex justify-content-between align-items-center mb-3"><h3 class="mb-0">Elenco Contratti</h3><button id="btnAddContratto" class="btn btn-secondary btn-sm fw-bold" style="display:none;" onclick="window.nuovoContratto()"><i class="bi bi-plus-lg"></i> Nuovo Contratto</button></div><div class="card shadow-sm h-100"><div class="card-body h-100 d-flex flex-column"><div class="table-responsive table-fix-height"><table class="table table-bordered table-striped table-hover table-sticky-head excel-table" id="tabellaContrattiReal"><thead class="table-dark" id="theadContrattiFull"></thead><tbody id="tabellaContrattiFull"></tbody></table></div></div></div></div>
            
            <div id="view-migrazioni" class="view-section">
                <h3 class="mb-4"><i class="bi bi-airplane-engines"></i> Piano Migrazioni</h3>
                <div class="card shadow border-info mb-4">
                    <div class="card-header bg-info text-white fw-bold">PIANIFICA NUOVA MIGRAZIONE</div>
                    <div class="card-body bg-light">
                         <div class="row g-2 align-items-end">
                             <div class="col-md-3 col-12"><label class="fw-bold small">Seleziona Cliente</label><select id="migrClienteSelect" class="form-select form-select-sm" onchange="window.updateMigrationUserCount()"><option value="">Caricamento...</option></select></div>
                             <div class="col-md-1 col-6"><label class="fw-bold small">N. Utenti</label><input type="number" id="migrQta" class="form-control form-control-sm" readonly style="background-color: #e9ecef;"></div>
                             <div class="col-md-2 col-6"><label class="fw-bold small">Data Prevista</label><input type="date" id="migrData" class="form-control form-control-sm"></div>
                             <div class="col-md-2 col-6"><label class="fw-bold small">Stato Iniziale</label><select id="migrStato" class="form-select form-select-sm"><option value="Prevista" selected>Prevista</option><option value="Sospesa">Sospesa</option><option value="Pianificata">Pianificata</option><option value="Altro">Altro</option></select></div>
                             <div class="col-md-2 col-6"><label class="fw-bold small">Note</label><input type="text" id="migrNote" class="form-control form-control-sm" placeholder="Appunti..."></div>
                             <div class="col-md-2 col-12"><button class="btn btn-primary btn-sm w-100 fw-bold" onclick="window.salvaMigrazione()"><i class="bi bi-save"></i> SALVA</button></div>
                         </div>
                         <div class="form-text mt-2 small">Vengono mostrati solo i clienti con contratto attivo <b>OASNOTSNEW</b> o <b>OASUITNOT</b>.</div>
                    </div>
                </div>
                <div class="card shadow-sm h-100" style="min-height: 400px;">
                    <div class="card-body p-0 h-100 d-flex flex-column">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0" id="tabellaMigrazioniReal">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Azioni</th>
                                        <th>Stato<input type="text" id="filterMigrStato" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                        <th style="min-width: 140px;">Data Prevista
                                            <div class="d-flex flex-column gap-1 mt-1">
                                                <input type="date" id="filterMigrDateStart" class="form-control form-control-sm p-1" style="font-size: 0.7rem;" onchange="window.applyMigrazioniFilters()">
                                                <input type="date" id="filterMigrDateEnd" class="form-control form-control-sm p-1" style="font-size: 0.7rem;" onchange="window.applyMigrazioniFilters()">
                                            </div>
                                        </th>
                                        <th>SAP<input type="text" id="filterMigrSap" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                        <th>Cliente<input type="text" id="filterMigrCliente" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                        <th style="min-width: 150px;">Account
                                            <select id="filterMigrAccountMulti" class="form-select form-select-sm mt-1" multiple size="3" style="font-size:0.7rem;" onchange="window.applyMigrazioniFilters()">
                                            </select>
                                        </th>
                                        <th>Sistema Attuale<input type="text" id="filterMigrSistema" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                        <th class="text-center">Utenti<input type="text" id="filterMigrUtenti" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                        <th>Note<input type="text" id="filterMigrNote" class="header-filter" onkeyup="window.applyMigrazioniFilters()"></th>
                                    </tr>
                                </thead>
                                <tbody id="tabellaMigrazioniBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-report-migrazioni" class="view-section">
                <h3 class="mb-4"><i class="bi bi-calendar3"></i> Report Annuale Migrazioni</h3>
                <div class="card shadow-sm mb-3">
                    <div class="card-body bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-6 col-12">
                                <label class="fw-bold small mb-1">Filtra per Account</label>
                                <div class="input-group"><select id="reportMigrAccountFilter" class="form-select" multiple size="3"></select><button class="btn btn-primary fw-bold" onclick="window.generateMigrationReport()"><i class="bi bi-funnel-fill"></i> APPLICA</button></div>
                            </div>
                            <div class="col-md-6 col-12 text-end"><div class="d-inline-block bg-warning p-2 rounded small border border-dark"><i class="bi bi-exclamation-triangle-fill"></i> Celle gialle = 0 Studi/Utenti.</div></div>
                        </div>
                    </div>
                </div>
                <div class="card shadow h-100"><div class="card-body p-0 h-100 d-flex flex-column"><div class="table-responsive table-fix-height"><table class="table table-bordered table-sm text-center align-middle mb-0" style="font-size: 0.8rem;"><thead class="table-dark sticky-top" style="top:0; z-index:1020;"><tr><th rowspan="2" class="align-middle bg-primary" style="min-width:150px; position:sticky; left:0; z-index:1030;">ACCOUNT</th><th colspan="2">GEN</th><th colspan="2">FEB</th><th colspan="2">MAR</th><th colspan="2">APR</th><th colspan="2">MAG</th><th colspan="2">GIU</th><th colspan="2">LUG</th><th colspan="2">AGO</th><th colspan="2">SET</th><th colspan="2">OTT</th><th colspan="2">NOV</th><th colspan="2">DIC</th><th colspan="2" class="bg-success text-white">TOTALE</th></tr><tr><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-secondary text-white">S</th><th class="bg-secondary text-white">U</th><th class="bg-success text-white">S</th><th class="bg-success text-white">U</th></tr></thead><tbody id="tbodyReportMigrazioni"></tbody></table></div></div></div>
            </div>

            <div id="view-statistiche" class="view-section">
                <h3 class="mb-4"><i class="bi bi-map"></i> Analisi Geografica Clienti</h3>
                <div class="card shadow-sm mb-3"><div class="card-header bg-dark text-white fw-bold">FILTRI INCROCIATI</div><div class="card-body bg-light"><div class="row g-3 align-items-start"><div class="col-md-3 col-12"><label class="form-label fw-bold small">SISTEMI</label><div id="filterMapSistemaContainer" class="checkbox-container"><div class="text-muted small p-2">Caricamento...</div></div></div><div class="col-md-3 col-12"><label class="form-label fw-bold small">ACCOUNT</label><select id="filterMapAccount" class="form-select"><option value="">Tutti</option></select></div><div class="col-md-4 col-12"><label class="form-label fw-bold small">RANGE VALORE TOTALE (€)</label><div class="input-group"><span class="input-group-text">Min</span><input type="number" id="filterMapMin" class="form-control" placeholder="0"><span class="input-group-text">Max</span><input type="number" id="filterMapMax" class="form-control" placeholder="50000"></div></div><div class="col-md-2 col-12 align-self-center mt-2"><button class="btn btn-primary w-100 fw-bold py-3" onclick="window.aggiornaMappa()"><i class="bi bi-search"></i> CALCOLA</button></div></div></div></div>
                <div class="card shadow h-100"><div class="card-body p-0"><div id="mapContainer" style="height: 600px; width: 100%;"></div></div><div class="card-footer small text-muted">Risultati trovati: <span id="mapResultCount" class="fw-bold text-primary">0</span>.</div></div>
            </div>
            
            <div id="view-strumenti" class="view-section">
                <h3 class="mb-4 text-warning"><i class="bi bi-tools"></i> Strumenti Amministratore</h3>
                
                <div class="row mb-4">
                     <div class="col-12">
                        <div class="card shadow border-dark">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <span class="fw-bold"><i class="bi bi-people-fill"></i> GESTIONE UTENTI (DATABASE)</span>
                                <button class="btn btn-sm btn-light fw-bold" onclick="window.newUserAdmin()"><i class="bi bi-plus-lg"></i> AGGIUNGI UTENTE</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 250px;">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="table-light"><tr><th>Azioni</th><th>Email (Auth)</th><th>Account Name</th><th>Ruolo</th></tr></thead>
                                        <tbody id="tbodyUsersAdmin"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>

                <div class="row">
                    <div class="col-md-4 col-12 mb-3"><div class="card shadow h-100 border-primary"><div class="card-header bg-primary text-white fw-bold">CLIENTI</div><div class="card-body"><div class="input-group mb-2"><input type="file" class="form-control" id="fileClienti" accept=".xlsx, .xls"><button class="btn btn-success" onclick="window.importExcel('fileClienti', 'clienti')"><i class="bi bi-upload"></i></button></div><button class="btn btn-warning w-100 mb-2" onclick="window.exportExcel('clienti')"><i class="bi bi-download"></i> Backup Excel</button><button class="btn btn-outline-danger w-100" onclick="window.clearTable('clienti')"><i class="bi bi-trash"></i> Svuota</button></div></div></div>
                    <div class="col-md-4 col-12 mb-3"><div class="card shadow h-100 border-secondary"><div class="card-header bg-secondary text-white fw-bold">CONTRATTI</div><div class="card-body"><div class="input-group mb-2"><input type="file" class="form-control" id="fileContratti" accept=".xlsx, .xls"><button class="btn btn-success" onclick="window.importExcel('fileContratti', 'contratti')"><i class="bi bi-upload"></i></button></div><button class="btn btn-info w-100 mb-2" onclick="window.valorizzaAccountContratti()">Valorizza Account</button><button class="btn btn-warning w-100 mb-2" onclick="window.exportExcel('contratti')">Backup Excel</button><button class="btn btn-outline-danger w-100" onclick="window.clearTable('contratti')">Svuota</button></div></div></div>
                    <div class="col-md-4 col-12 mb-3"><div class="card shadow h-100 border-success"><div class="card-header bg-success text-white fw-bold">FATTURATO</div><div class="card-body"><div class="input-group mb-2"><input type="file" class="form-control" id="fileFatturato" accept=".xlsx, .xls"><button class="btn btn-success" onclick="window.importExcel('fileFatturato', 'fatturato')"><i class="bi bi-upload"></i></button></div><button class="btn btn-warning w-100 mb-2" onclick="window.exportExcel('fatturato')">Backup Excel</button><button class="btn btn-outline-danger w-100" onclick="window.clearTable('fatturato')">Svuota</button></div></div></div>
                </div>
                <div class="alert alert-info mt-4" id="dbStatus">Connessione...</div>
            </div>

            <div class="app-footer">© • GS 2026</div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    const firebaseConfig = { 
      apiKey: "AIzaSyByeNqaD8cP70hGiDVtBhLmdB9aSMUjt-Y", 
      authDomain: "flow-manager-b0552.firebaseapp.com", 
      databaseURL: "https://flow-manager-b0552-default-rtdb.europe-west1.firebasedatabase.app", 
      projectId: "flow-manager-b0552", 
      storageBucket: "flow-manager-b0552.firebasestorage.app", 
      messagingSenderId: "867392252907", 
      appId: "1:867392252907:web:f4e2e6e8200132626207ae", 
      measurementId: "G-MTT2EDHVXZ" 
    }; 
    const app = initializeApp(firebaseConfig); 
    const db = getDatabase(app); 
    const auth = getAuth(app); 

    // === RBAC + Normalizzazione Account ===
    let globalClienti = [], globalContratti = [], globalFatturato = [], globalMigrazioni = []; 
    let globalUsers = {}; 
    let mapInstance = null; 
    let markersGroup = null; 
    let currentUserEmail = ""; 
    let currentAccountName = ""; 
    let currentUserRole = ""; 

    let currentAccountKeys = new Set();
    let allowedSAPSet = new Set();
    let clientiView = [], contrattiView = [], fatturatoView = [], migrazioniView = [];

    const isCurrentAdmin = () => { return currentUserRole === "ADMIN"; };

    // --- Helpers normalizzazione ---
    const _base = (s) => (s || "").toString().trim()
      .normalize('NFD').replace(/[̀-ͯ]/g, '')
      .replace(/["'`’]/g, '')
      .replace(/\s+/g, ' ')
      .toUpperCase();
    const _nameTokens = (s) => _base(s).split(' ').filter(Boolean);
    const accountKey = (name) => { const t = _nameTokens(name); if(t.length===0) return ''; if(t.length===1) return t[0]; const a=t[0], b=t[t.length-1]; return [a,b].sort().join('|'); };
    const accountFromEmail = (email) => { const local=(email||'').split('@')[0]; const parts = local.split(/[._-]+/).filter(Boolean); if(parts.length>=2){ const nome=_base(parts[0]); const cognome=_base(parts[1]); return `${cognome} ${nome}`.trim(); } return _base(local); };
    const buildCurrentAccountKeys = () => { currentAccountKeys = new Set(); if(currentAccountName){ currentAccountKeys.add(accountKey(currentAccountName)); const t=_nameTokens(currentAccountName); if(t.length>=2){ const inv = `${t[t.length-1]} ${t.slice(0,-1).join(' ')}`.trim(); currentAccountKeys.add(accountKey(inv)); } } if(currentUserEmail){ const disp=accountFromEmail(currentUserEmail); currentAccountKeys.add(accountKey(disp)); const t=_nameTokens(disp); if(t.length>=2){ const inv = `${t[t.length-1]} ${t.slice(0,-1).join(' ')}`.trim(); currentAccountKeys.add(accountKey(inv)); } } };
    const recordBelongsToUser = (accValue, sapValue) => { if(isCurrentAdmin()) return true; if(accValue && currentAccountKeys.has(accountKey(accValue))) return true; if(sapValue && allowedSAPSet.has(String(sapValue).trim())) return true; return false; };
    const rebuildVisibilityContext = () => {
      clientiView = isCurrentAdmin() ? [...globalClienti] : globalClienti.filter(c => recordBelongsToUser(c.Account, c.SAP));
      allowedSAPSet = new Set(clientiView.map(c => String(c.SAP).trim()));
      contrattiView = isCurrentAdmin() ? [...globalContratti] : globalContratti.filter(c => { const acc=c['Account']||c["Agente_dell'ORDINE"]; return recordBelongsToUser(acc, c.SAP); });
      fatturatoView = isCurrentAdmin() ? [...globalFatturato] : globalFatturato.filter(o => recordBelongsToUser(o.Account, o.SAP));
      migrazioniView = isCurrentAdmin() ? [...globalMigrazioni] : globalMigrazioni.filter(m => recordBelongsToUser(m.Account, m.SAP));
    };

    window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebarOverlay').classList.toggle('show'); };

    // --- LOGIN ---
    window.appLogin = () => { const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value; if(!u || !p) return alert("Inserisci email e password"); signInWithEmailAndPassword(auth, u, p).then(()=>{}).catch((error)=>{ console.error(error); let msg = "Errore login."; if(error.code==='auth/invalid-credential') msg="Email o Password errati."; alert(msg); }); };
    window.loginGoogle = () => { const provider = new GoogleAuthProvider(); signInWithPopup(auth, provider).then(()=>{}).catch((error)=>{ console.error(error); alert("Errore accesso Google: "+error.message); }); };
    window.appLogout = () => { signOut(auth).then(()=>{ location.reload(); }); };

    onAuthStateChanged(auth, (user) => { if (user) { checkUserMapping(user); } else { document.getElementById('loginOverlay').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; } });

    function checkUserMapping(firebaseUser) { const email = firebaseUser.email.toLowerCase(); const userKey = Object.keys(globalUsers).find(k => globalUsers[k].u && globalUsers[k].u.toLowerCase() === email); if (userKey) { const uData = globalUsers[userKey]; currentUserEmail = email; currentAccountName = uData.acc; currentUserRole = uData.role || 'USER'; document.getElementById('userDisplay').innerText = currentAccountName; document.getElementById('userEmailDisplay').innerText = email; buildCurrentAccountKeys(); startApp(); } else { alert("Accesso riuscito, ma l'utente non è configurato nel gestionale. Contatta l'amministratore per farti assegnare un Ruolo."); currentUserEmail = email; currentAccountName = firebaseUser.displayName || accountFromEmail(email); currentUserRole = 'GUEST'; document.getElementById('userDisplay').innerText = currentAccountName; document.getElementById('userEmailDisplay').innerText = email; buildCurrentAccountKeys(); startApp(); } }

    function startApp() { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainApp').style.display = 'flex'; if (!isCurrentAdmin()) { document.getElementById('nav-item-strumenti').style.display = 'none'; document.getElementById('btnAddCliente').style.display = 'none'; document.getElementById('btnAddContratto').style.display = 'none'; } else { document.getElementById('nav-item-strumenti').style.display = 'block'; document.getElementById('btnAddCliente').style.display = 'block'; document.getElementById('btnAddContratto').style.display = 'block'; } rebuildVisibilityContext(); renderTabelle(); if(!document.querySelector('.active-view')) window.navigate('home'); }

    // --- GESTIONE UTENTI ADMIN (unchanged) ---
    window.newUserAdmin = () => { document.getElementById('formEditUser').reset(); document.getElementById('editUserKey').value = ''; new bootstrap.Modal(document.getElementById('modalEditUser')).show(); };
    window.editUserAdmin = (key) => { const u = globalUsers[key]; if(!u) return; document.getElementById('editUserKey').value = key; document.getElementById('editUserEmail').value = u.u || ''; document.getElementById('editUserAcc').value = u.acc || ''; document.getElementById('editUserRole').value = u.role || 'USER'; new bootstrap.Modal(document.getElementById('modalEditUser')).show(); };
    window.saveUserAdmin = () => { const key = document.getElementById('editUserKey').value; const email = document.getElementById('editUserEmail').value.toLowerCase().trim(); const acc = document.getElementById('editUserAcc').value; const role = document.getElementById('editUserRole').value; if(!email || !acc) return alert("Email e Nome Account sono obbligatori."); const userData = { u: email, acc: acc, role: role }; if(key) { update(ref(db, `users/${key}`), userData).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide(); renderUsersTable(); }); } else { push(ref(db, 'users'), userData).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide(); renderUsersTable(); }); } };
    window.deleteUserAdmin = (key) => { if(confirm("Eliminare questa mappatura utente?")) { remove(ref(db, `users/${key}`)); } };
    const renderUsersTable = () => { const tbody = document.getElementById('tbodyUsersAdmin'); if(!tbody) return; tbody.innerHTML = ''; Object.keys(globalUsers).forEach(key => { const u = globalUsers[key]; const badgeRole = u.role === 'ADMIN' ? '<span class="badge bg-danger">ADMIN</span>' : '<span class="badge bg-secondary">User</span>'; tbody.innerHTML += ` <tr> <td><button class="btn btn-sm btn-outline-primary" onclick="window.editUserAdmin('${key}')"><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="window.deleteUserAdmin('${key}')"><i class="bi bi-trash"></i></button></td> <td>${u.u}</td> <td>${u.acc}</td> <td>${badgeRole}</td> </tr>`; }); };

    // --- Navigazione / init ---
    window.navigate = (view) => { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view')); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); document.getElementById('view-' + view).classList.add('active-view'); const nav = document.getElementById('nav-' + view); if(nav) nav.classList.add('active'); if(window.innerWidth < 992) window.toggleSidebar(); if (view === 'statistiche') window.initStatistiche(); if (view === 'migrazioni') { window.populateMigrationForm(); } if (view === 'report-migrazioni') window.initReportMigrazioni(); if (view === 'strumenti' && isCurrentAdmin()) renderUsersTable(); };

    const parseCurrency = (val) => { if (!val) return 0; if (typeof val === 'number') return val; return parseFloat(val.toString().replace('€', '').replace(/\./g, '').replace(',', '.').trim()) || 0; };

  // --- Helpers per popup mappa (escape HTML + link tel/mail) ---
  const escapeHtml = (unsafe) => (unsafe ?? '').toString().replace(/[&<>"'`=\/]/g, (c) => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;', '=': '&#61;', '/': '&#47;'
  }[c]));
  const cleanPhone = (p) => (p ?? '').toString().trim();
  const phoneHref = (p) => {
    const digits = cleanPhone(p).replace(/[^0-9+]/g, '');
    return digits ? `tel:${digits}` : '';
  };
  const cleanEmail = (e) => (e ?? '').toString().trim();
  const emailHref = (e) => {
    const em = cleanEmail(e);
    return em ? `mailto:${encodeURIComponent(em)}` : '';
  };

 const getCodiceFiscale = (obj) => {
  if(!obj) return '';
  return (obj.Codice_Fiscale ?? obj['Codice_Fiscale\r'] ?? obj['Codice_Fiscale\r\n'] ?? obj['Codice_Fiscale\n'] ?? obj['Codice_Fiscale '] ?? '');
 };


    // --- STATISTICHE / MIGRAZIONI (adattati su *View) ---
    window.toggleSystemCheckboxes = (source) => { const container = document.getElementById('filterMapSistemaContainer'); const checkboxes = container.querySelectorAll('input[type="checkbox"]'); checkboxes.forEach(cb => { if(cb.id !== 'sys_ALL') cb.checked = source.checked; }); };
    window.populateMigrationForm = () => { const select = document.getElementById('migrClienteSelect'); select.innerHTML = '<option value="">-- Seleziona Cliente da Migrare --</option>'; const targetSystems = ['OASNOTSNEW', 'OASUITNOT']; const eligibleContracts = contrattiView.filter(c => targetSystems.includes(c.Codice_SISTEMA)); eligibleContracts.sort((a,b) => (a.Nome || '').localeCompare(b.Nome || '')); eligibleContracts.forEach(con => { const valData = JSON.stringify({ sap: con.SAP, cliente: con.Nome, account: con.Account, sistema: con.Codice_SISTEMA, qta: con["QUANTITA'"] || 0 }); const label = `${con.Nome} (SAP: ${con.SAP}) - ${con.Codice_SISTEMA}`; select.innerHTML += `<option value='${valData}'>${label}</option>`; }); };
    window.updateMigrationUserCount = () => { const select = document.getElementById('migrClienteSelect'); const rawVal = select.value; if(!rawVal){ document.getElementById('migrQta').value=''; return;} try { const data = JSON.parse(rawVal); document.getElementById('migrQta').value = data.qta; } catch(e){ console.error('Errore parsing dati migrazione', e);} };
    window.salvaMigrazione = () => { const rawVal = document.getElementById('migrClienteSelect').value; const dataPrev = document.getElementById('migrData').value; const stato = document.getElementById('migrStato').value; const note = document.getElementById('migrNote').value; if(!rawVal) return alert("Seleziona un cliente."); if(!dataPrev) return alert("Inserisci la data prevista."); const data = JSON.parse(rawVal); const accountToSave = isCurrentAdmin() ? (data.account || currentAccountName) : currentAccountName; const newMigr = { SAP: data.sap, Cliente: data.cliente, Account: accountToSave ? _base(accountToSave) : '', Sistema_Attuale: data.sistema, Utenti_Migrazione: parseInt(data.qta) || 0, Data_Prevista: dataPrev, Data_Inserimento: new Date().toISOString().split('T')[0], Stato: stato, Note: note }; push(ref(db, 'migrazioni'), newMigr).then(() => { alert("Migrazione pianificata con successo!"); document.getElementById('migrClienteSelect').value = ''; document.getElementById('migrQta').value = ''; document.getElementById('migrData').value = ''; document.getElementById('migrNote').value = ''; }).catch(e => alert(e.message)); };
    window.openEditMigrazione = (key) => { const migr = migrazioniView.find(m => m.firebaseKey === key) || globalMigrazioni.find(m => m.firebaseKey === key); if(!migr) return; document.getElementById('editMigrKey').value = key; document.getElementById('editMigrCliente').value = `${migr.Cliente} (${migr.SAP})`; document.getElementById('editMigrData').value = migr.Data_Prevista || ''; document.getElementById('editMigrStato').value = migr.Stato || 'Prevista'; document.getElementById('editMigrNote').value = migr.Note || ''; new bootstrap.Modal(document.getElementById('modalEditMigrazione')).show(); };
    window.saveEditMigrazione = () => { const key = document.getElementById('editMigrKey').value; if(!key) return; const updates = { Data_Prevista: document.getElementById('editMigrData').value, Stato: document.getElementById('editMigrStato').value, Note: document.getElementById('editMigrNote').value }; update(ref(db, `migrazioni/${key}`), updates).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditMigrazione')).hide(); alert("Migrazione aggiornata!"); }).catch(e => alert(e.message)); };
    window.eliminaMigrazione = (key) => { if(confirm("Eliminare?")) remove(ref(db, `migrazioni/${key}`)); };
    window.populateMigrAccountFilter = () => { const select = document.getElementById('filterMigrAccountMulti'); if(!select) return; select.innerHTML = ''; const allAccounts = new Set(); const src = isCurrentAdmin() ? globalMigrazioni : migrazioniView; src.forEach(m => { if(m.Account) allAccounts.add(_base(m.Account)); }); Array.from(allAccounts).sort().forEach(acc => { select.innerHTML += `<option value="${acc}">${acc}</option>`; }); };
    window.applyMigrazioniFilters = () => { const tbody = document.getElementById('tabellaMigrazioniBody'); const trs = tbody.getElementsByTagName("tr"); const fStato = document.getElementById('filterMigrStato').value.toUpperCase(); const fDateStartVal = document.getElementById('filterMigrDateStart').value; const fDateEndVal = document.getElementById('filterMigrDateEnd').value; const fDateStart = fDateStartVal ? new Date(fDateStartVal) : null; const fDateEnd = fDateEndVal ? new Date(fDateEndVal) : null; const fSap = document.getElementById('filterMigrSap').value.toUpperCase(); const fCliente = document.getElementById('filterMigrCliente').value.toUpperCase(); const selAccount = document.getElementById('filterMigrAccountMulti'); const fAccounts = Array.from(selAccount.selectedOptions).map(o => o.value.toUpperCase()); const fSistema = document.getElementById('filterMigrSistema').value.toUpperCase(); const fUtenti = document.getElementById('filterMigrUtenti').value.toUpperCase(); const fNote = document.getElementById('filterMigrNote').value.toUpperCase(); for (let i = 0; i < trs.length; i++) { const tds = trs[i].getElementsByTagName("td"); if(tds.length < 2) continue; const txtStato = (tds[1].textContent || "").toUpperCase(); const txtData = (tds[2].textContent || "").trim(); const txtSap = (tds[3].textContent || "").toUpperCase(); const txtCliente = (tds[4].textContent || "").toUpperCase(); const txtAccount = (tds[5].textContent || "").toUpperCase(); const txtSistema = (tds[6].textContent || "").toUpperCase(); const txtUtenti = (tds[7].textContent || "").toUpperCase(); const txtNote = (tds[8].textContent || "").toUpperCase(); let show = true; if (fStato && txtStato.indexOf(fStato) === -1) show = false; if (show && fSap && txtSap.indexOf(fSap) === -1) show = false; if (show && fCliente && txtCliente.indexOf(fCliente) === -1) show = false; if (show && fSistema && txtSistema.indexOf(fSistema) === -1) show = false; if (show && fUtenti && txtUtenti.indexOf(fUtenti) === -1) show = false; if (show && fNote && txtNote.indexOf(fNote) === -1) show = false; if (show && fAccounts.length > 0) { if (!fAccounts.includes(txtAccount)) show = false; } if (show && (fDateStart || fDateEnd)) { if(!txtData) { show = false; } else { const parts = txtData.split('/'); if(parts.length === 3) { const rowDate = new Date(parts[2], parts[1]-1, parts[0]); if (fDateStart && rowDate < fDateStart) show = false; if (fDateEnd && rowDate > fDateEnd) show = false; } else { show = false; } } } trs[i].style.display = show ? "" : "none"; } };
    function renderTabellaMigrazioni() { const tbody = document.getElementById('tabellaMigrazioniBody'); tbody.innerHTML = ''; const sorted = [...migrazioniView].sort((a,b) => new Date(a.Data_Prevista) - new Date(b.Data_Prevista)); window.populateMigrAccountFilter(); if(sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Nessuna migrazione pianificata.</td></tr>'; return; } sorted.forEach(m => { let badgeClass = 'bg-secondary'; if(m.Stato === 'Prevista') badgeClass = 'bg-warning text-dark'; else if(m.Stato === 'Pianificata') badgeClass = 'bg-success'; else if(m.Stato === 'Sospesa') badgeClass = 'bg-danger'; else if(m.Stato === 'Altro') badgeClass = 'bg-info text-dark'; const d = new Date(m.Data_Prevista); const dataFmt = !isNaN(d) ? d.toLocaleDateString('it-IT') : m.Data_Prevista; tbody.innerHTML += ` <tr> <td style="white-space:nowrap;"> <button class="btn btn-sm btn-outline-primary me-1" onclick="window.openEditMigrazione('${m.firebaseKey}')"><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="window.eliminaMigrazione('${m.firebaseKey}')"><i class="bi bi-trash"></i></button> </td> <td><span class="badge ${badgeClass}">${m.Stato || 'Prevista'}</span></td> <td class="fw-bold">${dataFmt}</td> <td>${m.SAP || ''}</td> <td>${m.Cliente || ''}</td> <td>${m.Account || ''}</td> <td class="text-info font-monospace">${m.Sistema_Attuale || ''}</td> <td class="text-center fw-bold fs-6">${m.Utenti_Migrazione}</td> <td class="small text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${m.Note || ''}</td> </tr>`; }); }

    // --- STATISTICHE ---
    window.initStatistiche = () => { const boxContainer = document.getElementById('filterMapSistemaContainer'); if(!boxContainer.querySelector('input')) { const sistemiUnici = [...new Set(contrattiView.map(c => c.Codice_SISTEMA).filter(x => x))].sort(); boxContainer.innerHTML = ` <div class="form-check border-bottom mb-2 pb-1 sticky-top bg-white"> <input class="form-check-input fw-bold" type="checkbox" id="sys_ALL" onclick="window.toggleSystemCheckboxes(this)"> <label class="form-check-label fw-bold" for="sys_ALL">Tutti</label> </div>`; if(sistemiUnici.length === 0) boxContainer.innerHTML = '<span class="text-muted small">Nessun sistema trovato.</span>'; sistemiUnici.forEach(s => { const id = `sys_${s.replace(/[^a-zA-Z0-9]/g, '')}`; boxContainer.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${s}" id="${id}"><label class="form-check-label small" for="${id}">${s}</label></div>`; }); } const selAcc = document.getElementById('filterMapAccount'); if(selAcc.options.length <= 1) { selAcc.innerHTML = '<option value="">Tutti</option>'; const accountsUnici = [...new Set(clientiView.map(c => c.Account).filter(x => x))].sort(); accountsUnici.forEach(a => selAcc.innerHTML += `<option value="${a}">${a}</option>`); } if (!mapInstance) { mapInstance = L.map('mapContainer').setView([41.9028, 12.4964], 6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(mapInstance); markersGroup = L.layerGroup().addTo(mapInstance);
 if (!mapInstance._gsPopupHandlersAdded) {
   mapInstance.on('click', () => mapInstance.closePopup());
   document.addEventListener('keydown', (ev) => { if(ev.key === 'Escape') mapInstance.closePopup(); });
   mapInstance._gsPopupHandlersAdded = true;
 }
 } setTimeout(() => { mapInstance.invalidateSize(); }, 200); };
    window.aggiornaMappa = async () => { if(!markersGroup) return; markersGroup.clearLayers(); const checkedBoxes = document.querySelectorAll('#filterMapSistemaContainer input:checked'); const selectedSystems = Array.from(checkedBoxes).map(cb => cb.value).filter(val => val !== "" && val !== "on"); const accFilter = document.getElementById('filterMapAccount').value; const minVal = parseFloat(document.getElementById('filterMapMin').value) || 0; const maxVal = parseFloat(document.getElementById('filterMapMax').value) || 99999999; const contrattiPerCliente = {}; contrattiView.forEach(c => { const matchSystem = selectedSystems.length === 0 || selectedSystems.includes(c.Codice_SISTEMA); if (matchSystem) { const sapKey = String(c.SAP).trim(); if(!contrattiPerCliente[sapKey]) contrattiPerCliente[sapKey] = []; contrattiPerCliente[sapKey].push(c); } }); const clientiDaMappare = []; clientiView.forEach(cli => { const sapKey = String(cli.SAP).trim(); if (accFilter !== "" && cli.Account !== accFilter) return; const contrattiDelCliente = contrattiPerCliente[sapKey] || []; const totaleValore = contrattiDelCliente.reduce((sum, c) => sum + parseCurrency(c.VALORE_RINNOVO), 0); if (totaleValore >= minVal && totaleValore <= maxVal) { if(selectedSystems.length > 0 && contrattiDelCliente.length === 0 && minVal > 0) return; if (cli.Città) { cli._tempTotale = totaleValore; cli._tempSistemi = [...new Set(contrattiDelCliente.map(c => c.Codice_SISTEMA))].join(", "); clientiDaMappare.push(cli); } } }); document.getElementById('mapResultCount').innerText = clientiDaMappare.length; if(clientiDaMappare.length === 0) return alert("Nessun cliente soddisfa i criteri."); if(clientiDaMappare.length > 50 && !confirm(`Trovati ${clientiDaMappare.length} clienti. Continuare?`)) return; let count = 0; for (const cli of clientiDaMappare) { let queryParts = []; if(cli.Via_e_numero) queryParts.push(cli.Via_e_numero); if(cli.Città) queryParts.push(cli.Città); if(cli.Prov) queryParts.push(cli.Prov); queryParts.push("Italy"); const query = queryParts.join(', '); try { const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`); const data = await response.json(); if (data && data.length > 0) { let lat = parseFloat(data[0].lat); let lon = parseFloat(data[0].lon); lat += (Math.random() - 0.5) * 0.0004; lon += (Math.random() - 0.5) * 0.0004; const marker = L.marker([lat, lon]); const valFmt = cli._tempTotale.toLocaleString('it-IT', {style: 'currency', currency: 'EUR'}); const popupContent = `
                  <div style="font-size:0.9rem; min-width: 240px;">
                    <div class="fw-bold text-primary mb-1">${escapeHtml(cli.Nome)}</div>
                    <div class="small text-muted">SAP: <b>${escapeHtml(cli.SAP)}</b></div>
                    <div class="small">${escapeHtml(cli.Città)}${cli.Prov ? ` (${escapeHtml(cli.Prov)})` : ''}</div>
                    ${cli.Via_e_numero ? `<div class="small mb-2">${escapeHtml(cli.Via_e_numero)}</div>` : `<div class="small mb-2 text-muted">Indirizzo: N/D</div>`}
                    <div class="d-flex flex-column gap-1 mb-2" style="line-height:1.2;">
                      ${cleanPhone(cli.Telefono) ? `<a href="${escapeHtml(phoneHref(cli.Telefono))}" class="text-decoration-none"><i class="bi bi-telephone-fill me-1"></i>${escapeHtml(cleanPhone(cli.Telefono))}</a>` : `<span class="text-muted small"><i class="bi bi-telephone me-1"></i>Telefono: N/D</span>`}
                      ${cleanEmail(cli.e_mail) ? `<a href="${escapeHtml(emailHref(cli.e_mail))}" class="text-decoration-none"><i class="bi bi-envelope-fill me-1"></i>${escapeHtml(cleanEmail(cli.e_mail))}</a>` : `<span class="text-muted small"><i class="bi bi-envelope me-1"></i>Email: N/D</span>`}
                    </div>
                    <div class="bg-light p-2 rounded border">
                      <div><small>Totale sistemi selezionati: <b>${valFmt}</b></small></div>
                      <div class="small text-secondary" style="font-size:0.75rem">${escapeHtml(cli._tempSistemi || '')}</div>
                    </div>
                  </div>`;
                marker.bindPopup(popupContent, { closeButton: true, autoClose: true, closeOnClick: false, autoPan: true });
 marker.on('click', function (e) { L.DomEvent.stopPropagation(e); this.openPopup(); });
 markersGroup.addLayer(marker); count++; } await new Promise(r => setTimeout(r, 1100)); } catch (e) { console.error("Errore geocoding", query, e); } } if(count > 0) alert(`Mappa aggiornata! Visualizzati ${count} clienti.`); };

    // --- Scheda cliente / Ordini (adattati su *View) ---
    window.caricaScheda = () => { const q = document.getElementById('searchInput').value.toLowerCase(); if(!q) return; const cliente = clientiView.find(c => { const s = String(c.SAP || '').toLowerCase(); const n = String(c.Nome || '').toLowerCase(); return (q.includes(s) && q.includes(n)) || s.includes(q) || n.includes(q); }); if (cliente) { const colConfigs = [ { label: "SAP", key: "SAP" }, { label: "Nome", key: "Nome" }, { label: "PIVA", key: "PIVA" }, { label: "Cod. Fiscale", key: "Codice_Fiscale" }, { label: "Account", key: "Account" }, { label: "Via", key: "Via_e_numero" }, { label: "Città", key: "Città" }, { label: "Prov", key: "Prov" }, { label: "Telefono", key: "Telefono" }, { label: "Email", key: "e_mail" } ]; let th = "", td = ""; colConfigs.forEach(conf => { th += `<th>${conf.label}</th>`; let val = (conf.key === 'Codice_Fiscale') ? getCodiceFiscale(cliente) : (cliente[conf.key] ?? ''); td += `<td>${val}</td>`; }); document.getElementById('tabellaExcelHome').innerHTML = `<thead><tr>${th}</tr></thead><tbody><tr>${td}</tr></tbody>`; document.getElementById('cardDatiCompleti').style.display = 'block'; const contratti = contrattiView.filter(c => String(c.SAP) === String(cliente.SAP)); const tbody = document.getElementById('tabellaContrattiBodyHome'); tbody.innerHTML = contratti.length ? contratti.map(c => { const valMen = parseFloat(c.VAL_UN_MEN || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2}); let dataFmt = c.DATA_SCAD; if(c.DATA_SCAD) { const d = new Date(c.DATA_SCAD); if(!isNaN(d.getTime())) dataFmt = d.toLocaleDateString('it-IT'); } return `<tr><td>${c.SAP||''}</td><td>${c.Codice_SISTEMA||''}</td><td>€ ${c.VALORE_RINNOVO||0}</td><td class="fw-bold">€ ${valMen}</td><td>${c.TESTO_ORD_||''}</td><td>${dataFmt}</td><td>${c["QUANTITA'"]||''}</td><td>${c.PASSO||''}</td><td>${c.Pagamento||''}</td></tr>`; }).join('') : '<tr><td colspan="9" class="text-center text-muted">Nessun contratto.</td></tr>'; document.getElementById('cardContratti').style.display = 'block'; document.getElementById('cardNuovoOrdine').style.display = 'block'; document.getElementById('ordData').valueAsDate = new Date(); document.getElementById('ordSap').value = cliente.SAP || ''; document.getElementById('ordCliente').value = cliente.Nome || ''; document.getElementById('ordAccount').value = cliente.Account || ''; } else { alert("Cliente non trovato."); } };
    window.printContrattiCliente = () => { const cliente = document.getElementById('ordCliente').value; if(!cliente) return alert("Nessun cliente selezionato."); const tableHtml = document.querySelector('#cardContratti table').outerHTML; const printWin = window.open('', '', 'height=600,width=900'); printWin.document.write('<html><head><title>Stampa Contratti</title><style>body { font-family: "Segoe UI", sans-serif; padding: 20px; } h2 { color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 10px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f8f9fa; font-weight: bold; }</style></head><body>'); printWin.document.write(`<h2>Contratti Attivi: ${cliente}</h2>${tableHtml}</body></html>`); printWin.document.close(); printWin.focus(); setTimeout(() => { printWin.print(); printWin.close(); }, 500); };
    window.registraOrdine = () => { const ord = { Data_ordine: document.getElementById('ordData').value, SAP: document.getElementById('ordSap').value, Cliente: document.getElementById('ordCliente').value, Account: document.getElementById('ordAccount').value, Ordine_AP: document.getElementById('ordOrdineAP').value, Descrizione_Ordine: document.getElementById('ordDesc').value, Note: document.getElementById('ordNote').value, WKI_m: parseFloat(document.getElementById('ordWkiMese').value) || 0, M365_m: parseFloat(document.getElementById('ordM365Mese').value) || 0, Una_Tantum: parseFloat(document.getElementById('ordUnaTantum').value) || 0, Stato: document.getElementById('ordStato').value, Data_prima_fatt: document.getElementById('ordDataFatt').value, isFatturato: false, Finanaziata: "" }; if(!ord.SAP) return alert("Dati obbligatori mancanti (SAP)."); if(!isCurrentAdmin()) ord.Account = _base(currentAccountName); push(ref(db, 'fatturato'), ord).then(() => { alert("Ordine salvato!"); document.getElementById('formOrdine').reset(); window.navigate('fatturato'); }); };
    window.openEditOrdine = (key) => { const ord = fatturatoView.find(o => o.firebaseKey === key) || globalFatturato.find(o => o.firebaseKey === key); if(!ord) return; document.getElementById('editKey').value = key; document.getElementById('editData').value = ord.Data_ordine || ''; document.getElementById('editSap').value = ord.SAP || ''; document.getElementById('editCliente').value = ord.Cliente || ''; document.getElementById('editAccount').value = ord.Account || ''; document.getElementById('editOrdineAP').value = ord.Ordine_AP || ''; document.getElementById('editDesc').value = ord.Descrizione_Ordine || ''; document.getElementById('editNote').value = ord.Note || ''; document.getElementById('editWki').value = ord.WKI_m || 0; document.getElementById('editM365').value = ord.M365_m || 0; document.getElementById('editUna').value = ord.Una_Tantum || 0; document.getElementById('editDataFatt').value = ord.Data_prima_fatt || ''; const selStato = document.getElementById('editStato'); selStato.innerHTML = ''; ['Evaso','da evadere','Sospeso','Parziale'].forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; if(s === ord.Stato) opt.selected = true; selStato.appendChild(opt); }); new bootstrap.Modal(document.getElementById('modalEditOrdine')).show(); };
    window.saveEditOrdine = () => { const key = document.getElementById('editKey').value; if(!key) return; const updates = { Data_ordine: document.getElementById('editData').value, SAP: document.getElementById('editSap').value, Cliente: document.getElementById('editCliente').value, Account: document.getElementById('editAccount').value, Ordine_AP: document.getElementById('editOrdineAP').value, Descrizione_Ordine: document.getElementById('editDesc').value, Note: document.getElementById('editNote').value, WKI_m: parseFloat(document.getElementById('editWki').value) || 0, M365_m: parseFloat(document.getElementById('editM365').value) || 0, Una_Tantum: parseFloat(document.getElementById('editUna').value) || 0, Stato: document.getElementById('editStato').value, Data_prima_fatt: document.getElementById('editDataFatt').value }; if(!isCurrentAdmin()) updates.Account = _base(currentAccountName); update(ref(db, `fatturato/${key}`), updates).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditOrdine')).hide(); alert("Modifiche salvate!"); }).catch(e => alert(e.message)); };

    // --- Clienti/Contratti (adattati su *View) ---
    window.nuovoCliente = () => { document.getElementById('formEditCliente').reset(); document.getElementById('cliKey').value = ''; new bootstrap.Modal(document.getElementById('modalEditCliente')).show(); };
    window.openEditCliente = (key) => { const cli = clientiView.find(c => c.firebaseKey === key) || globalClienti.find(c => c.firebaseKey === key); if(!cli) return; document.getElementById('cliKey').value = key; document.getElementById('cliSap').value = cli.SAP || ''; document.getElementById('cliNome').value = cli.Nome || ''; document.getElementById('cliPiva').value = cli.PIVA || ''; document.getElementById('cliSwOa').value = getCodiceFiscale(cli); document.getElementById('cliAccount').value = cli.Account || ''; document.getElementById('cliTel').value = cli.Telefono || ''; document.getElementById('cliVia').value = cli.Via_e_numero || ''; document.getElementById('cliCitta').value = cli.Città || ''; document.getElementById('cliProv').value = cli.Prov || ''; document.getElementById('cliEmail').value = cli.e_mail || ''; document.getElementById('cliNote').value = cli.Note || ''; new bootstrap.Modal(document.getElementById('modalEditCliente')).show(); };
    window.saveCliente = () => { const key = document.getElementById('cliKey').value; const data = { SAP: document.getElementById('cliSap').value, Nome: document.getElementById('cliNome').value, PIVA: document.getElementById('cliPiva').value, Codice_Fiscale: document.getElementById('cliSwOa').value, Account: document.getElementById('cliAccount').value, Telefono: document.getElementById('cliTel').value, Via_e_numero: document.getElementById('cliVia').value, Città: document.getElementById('cliCitta').value, Prov: document.getElementById('cliProv').value, e_mail: document.getElementById('cliEmail').value, Note: document.getElementById('cliNote').value }; if(key) update(ref(db, `clienti/${key}`), data).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditCliente')).hide(); alert("Cliente aggiornato!"); }); else push(ref(db, 'clienti'), data).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditCliente')).hide(); alert("Nuovo cliente creato!"); }); };
    window.eliminaCliente = (key) => { if(confirm("Sei sicuro di voler eliminare questo CLIENTE?")) remove(ref(db, `clienti/${key}`)); };
    window.nuovoContratto = () => { document.getElementById('formEditContratto').reset(); document.getElementById('conKey').value = ''; new bootstrap.Modal(document.getElementById('modalEditContratto')).show(); };
    window.openEditContratto = (key) => { const con = contrattiView.find(c => c.firebaseKey === key) || globalContratti.find(c => c.firebaseKey === key); if(!con) return; document.getElementById('conKey').value = key; document.getElementById('conSap').value = con.SAP || ''; document.getElementById('conNome').value = con.Nome || ''; document.getElementById('conAccount').value = con.Account || con["Agente_dell'ORDINE"] || ''; document.getElementById('conSistema').value = con.Codice_SISTEMA || ''; document.getElementById('conCodice').value = con.CODICE || ''; document.getElementById('conPagamento').value = con.Pagamento || ''; document.getElementById('conTesto').value = con.TESTO_ORD_ || ''; document.getElementById('conQta').value = con["QUANTITA'"] || ''; document.getElementById('conPasso').value = con.PASSO || ''; document.getElementById('conScadenza').value = con.DATA_SCAD ? con.DATA_SCAD.split('T')[0] : ''; document.getElementById('conValRinnovo').value = parseCurrency(con.VALORE_RINNOVO); document.getElementById('conValMensile').value = parseCurrency(con.VAL_UN_MEN); new bootstrap.Modal(document.getElementById('modalEditContratto')).show(); };
    window.saveContratto = () => { const key = document.getElementById('conKey').value; const data = { SAP: document.getElementById('conSap').value, Nome: document.getElementById('conNome').value, Account: document.getElementById('conAccount').value, Codice_SISTEMA: document.getElementById('conSistema').value, CODICE: document.getElementById('conCodice').value, Pagamento: document.getElementById('conPagamento').value, TESTO_ORD_: document.getElementById('conTesto').value, "QUANTITA'": document.getElementById('conQta').value, PASSO: document.getElementById('conPasso').value, DATA_SCAD: document.getElementById('conScadenza').value, VALORE_RINNOVO: parseFloat(document.getElementById('conValRinnovo').value) || 0, VAL_UN_MEN: parseFloat(document.getElementById('conValMensile').value) || 0 }; if(key) update(ref(db, `contratti/${key}`), data).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditContratto')).hide(); alert("Contratto aggiornato!"); }); else push(ref(db, 'contratti'), data).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditContratto')).hide(); alert("Nuovo contratto inserito!"); }); };
    window.eliminaContratto = (key) => { if(confirm("Sei sicuro di voler eliminare questo CONTRATTO?")) remove(ref(db, `contratti/${key}`)); };

    // --- Fatturato ---
    window.toggleFatturato = (el, key) => { const isChecked = el.checked; const updates = { isFatturato: isChecked }; if (isChecked) updates.Data_prima_fatt = new Date().toISOString().split('T')[0]; update(ref(db, `fatturato/${key}`), updates).then(() => renderTabelle()).catch(e => alert(e.message)); };
    window.salvaModificaCella = (el, key, field) => { let val = el.innerText; if(field.includes('WKI') || field.includes('M365') || field.includes('Una_Tantum')) val = parseFloat(val.replace('€','').replace(',','.').trim()) || 0; update(ref(db, `fatturato/${key}`), { [field]: val }).then(() => { el.style.backgroundColor = "#d4edda"; setTimeout(()=>el.style.backgroundColor="",500); if(field.includes('WKI')||field.includes('M365')||field.includes('Una_Tantum')||field.includes('Data_prima_fatt')) renderTabelle(); }).catch(e => alert(e.message)); };
    window.eliminaRigaFatturato = (key) => { if(confirm("Eliminare riga?")) remove(ref(db, `fatturato/${key}`)); };
    window.filterFatturato = (colIndex) => { const table = document.getElementById('tabellaFatturatoReal'); const trs = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"); const inputs = table.getElementsByTagName("thead")[0].getElementsByTagName("input"); let filters = []; for (let i = 0; i < inputs.length; i++) filters.push({ idx: i + 1, val: inputs[i].value.toUpperCase() }); for (let i = 0; i < trs.length; i++) { let show = true; const tds = trs[i].getElementsByTagName("td"); for (let f of filters) { if (f.val) { if (tds[f.idx]) { const txt = tds[f.idx].textContent || tds[f.idx].innerText; if (txt.toUpperCase().indexOf(f.val) === -1) { show = false; break; }}}} trs[i].style.display = show ? "" : "none"; } window.updateFatturatoTotals(); };
    window.filterClienti = (colIndex) => { const table = document.getElementById('tabellaClientiReal'); const trs = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"); const inputs = table.getElementsByTagName("thead")[0].getElementsByTagName("input"); const isAdmin = isCurrentAdmin(); const offset = isAdmin ? 1 : 0; let filters = []; for (let i = 0; i < inputs.length; i++) filters.push({ idx: i + offset, val: inputs[i].value.toUpperCase() }); for (let i = 0; i < trs.length; i++) { let show = true; const tds = trs[i].getElementsByTagName("td"); for (let f of filters) { if (f.val) { if (tds[f.idx]) { const txt = tds[f.idx].textContent || tds[f.idx].innerText; if (txt.toUpperCase().indexOf(f.val) === -1) { show = false; break; }}}} trs[i].style.display = show ? "" : "none"; } };
    window.filterContratti = (colIndex) => { const table = document.getElementById('tabellaContrattiReal'); const trs = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"); const inputs = table.getElementsByTagName("thead")[0].getElementsByTagName("input"); const isAdmin = isCurrentAdmin(); const offset = isAdmin ? 1 : 0; let filters = []; for (let i = 0; i < inputs.length; i++) filters.push({ idx: i + offset, val: inputs[i].value.toUpperCase() }); for (let i = 0; i < trs.length; i++) { let show = true; const tds = trs[i].getElementsByTagName("td"); for (let f of filters) { if (f.val) { if (tds[f.idx]) { const txt = tds[f.idx].textContent || tds[f.idx].innerText; if (txt.toUpperCase().indexOf(f.val) === -1) { show = false; break; }}}} trs[i].style.display = show ? "" : "none"; } };
    window.updateFatturatoTotals = () => { const tbody = document.getElementById('tabellaFatturatoFull'); const trs = tbody.getElementsByTagName('tr'); let sumUna = 0, sumFin = 0, sumWkiAn = 0, sumM365An = 0; for(let tr of trs) { if(tr.style.display !== 'none') { const tds = tr.getElementsByTagName('td'); if(tds.length > 17) { sumUna += parseFloat(tds[10].getAttribute('data-val')) || 0; sumFin += parseFloat(tds[16].getAttribute('data-val')) || 0; sumWkiAn += parseFloat(tds[17].getAttribute('data-val')) || 0; sumM365An += parseFloat(tds[18].getAttribute('data-val')) || 0; } } } document.getElementById('totUna').innerText = sumUna.toLocaleString('it-IT', {minimumFractionDigits: 2}); document.getElementById('totFin').innerText = sumFin.toLocaleString('it-IT', {minimumFractionDigits: 2}); document.getElementById('totWkiAn').innerText = sumWkiAn.toLocaleString('it-IT', {minimumFractionDigits: 2}); document.getElementById('totM365An').innerText = sumM365An.toLocaleString('it-IT', {minimumFractionDigits: 2}); document.getElementById('totGrand').innerText = (sumUna + sumFin).toLocaleString('it-IT', {minimumFractionDigits: 2}); };

    window.clearTable = (node) => { if(confirm(`Sei sicuro di voler SVUOTARE la tabella ${node.toUpperCase()}?`)) set(ref(db, node), null).then(() => alert("Tabella svuotata!")); };
    window.importExcel = (inputId, node) => { const file = document.getElementById(inputId).files[0]; if(!file) return alert("Seleziona un file Excel."); const reader = new FileReader(); reader.onload = (e) => { const workbook = XLSX.read(e.target.result, {type: 'binary'}); const sheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(sheet); if(jsonData.length === 0) return alert("File vuoto o non valido."); const nodeRef = ref(db, node); jsonData.forEach(row => push(nodeRef, row)); alert(`Importazione completata!`); }; reader.readAsBinaryString(file); };
    window.exportExcel = (node) => { let data = []; let name = ""; if(node === 'clienti') { data = globalClienti.map(({firebaseKey, _tempTotale, _tempSistemi, ...rest}) => rest); name = "Clienti.xlsx"; } else if(node === 'contratti') { data = globalContratti.map(({firebaseKey, ...rest}) => rest); name = "Contratti.xlsx"; } else if(node === 'fatturato') { data = globalFatturato.map(({firebaseKey, ...rest}) => rest); name = "Fatturato.xlsx"; } if(data.length === 0) return alert("Nessun dato da esportare."); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, node); XLSX.writeFile(wb, name); };
    window.valorizzaAccountContratti = () => { if(!confirm("Cercare Account da anagrafica clienti?")) return; let count = 0; const updates = {}; globalContratti.forEach(con => { const match = globalClienti.find(cli => { const sapMatch = cli.SAP && con.SAP && String(cli.SAP).trim() === String(con.SAP).trim(); const nameMatch = cli.Nome && con.Nome && String(cli.Nome).trim().toLowerCase() === String(con.Nome).trim().toLowerCase(); return sapMatch || nameMatch; }); if (match && match.Account && con.Account !== match.Account) { updates[`contratti/${con.firebaseKey}/Account`] = match.Account; count++; } }); if (count > 0) update(ref(db), updates).then(() => alert(`Aggiornati ${count} contratti!`)).catch(e => alert(e.message)); else alert("Nessun aggiornamento necessario."); };

    window.initReportMigrazioni = () => { const select = document.getElementById('reportMigrAccountFilter'); select.innerHTML = ''; if (isCurrentAdmin()) { const allAccounts = new Set(); Object.values(globalUsers).forEach(u => { if(u.acc && u.acc !== 'ADMIN') allAccounts.add(u.acc.trim()); }); globalMigrazioni.forEach(m => { if(m.Account) allAccounts.add(m.Account.trim()); }); Array.from(allAccounts).sort().forEach(acc => { select.innerHTML += `<option value="${acc}">${acc}</option>`; }); select.multiple = true; select.disabled = false; } else { const myAcc = _base(currentAccountName); select.innerHTML = `<option value="${myAcc}" selected>${myAcc}</option>`; select.multiple = false; select.disabled = true; } window.generateMigrationReport(); };
    window.generateMigrationReport = () => { const tbody = document.getElementById('tbodyReportMigrazioni'); tbody.innerHTML = ''; const select = document.getElementById('reportMigrAccountFilter'); let targetAccounts = Array.from(select.selectedOptions).map(opt => opt.value); if(targetAccounts.length === 0) targetAccounts = Array.from(select.options).map(o => o.value); const reportData = {}; targetAccounts.forEach(acc => { reportData[_base(acc)] = Array.from({length: 12}, () => ({studi: 0, utenti: 0})); }); const src = isCurrentAdmin() ? globalMigrazioni : migrazioniView; src.forEach(m => { const stato = (m.Stato || '').toLowerCase(); if((stato === 'prevista' || stato === 'pianificata') && m.Data_Prevista && m.Account) { const accUpper = _base(m.Account); if(reportData[accUpper]) { const date = new Date(m.Data_Prevista); if(!isNaN(date.getTime())) { const month = date.getMonth(); reportData[accUpper][month].studi += 1; reportData[accUpper][month].utenti += (parseInt(m.Utenti_Migrazione, 10) || 0); } } } }); targetAccounts.forEach(accDisplayName => { const upperKey = _base(accDisplayName); const data = reportData[upperKey]; if(!data) return; let row = `<tr><td class="fw-bold bg-light text-start ps-3" style="position:sticky; left:0; z-index:10; border-right:2px solid #dee2e6;">${accDisplayName}</td>`; let tS=0, tU=0; data.forEach(m => { tS+=m.studi; tU+=m.utenti; row += `<td class="${m.studi===0?'report-cell-warn':''}" style="${m.studi===0?'color:#ccc':''}">${m.studi}</td><td class="border-end ${m.utenti===0?'report-cell-warn':''}" style="${m.utenti===0?'color:#ccc':''}">${m.utenti}</td>`; }); row += `<td class="bg-success bg-opacity-25 fw-bold text-dark border-start border-dark">${tS}</td><td class="bg-success bg-opacity-25 fw-bold text-dark">${tU}</td></tr>`; tbody.innerHTML += row; }); if(targetAccounts.length === 0) tbody.innerHTML = '<tr><td colspan="27" class="text-center p-3">Nessun account trovato.</td></tr>'; };

    // --- Dropdowns e liste ---
    const _initDrops = () => { const dlAcc = document.getElementById('listAccounts'); dlAcc.innerHTML = ''; if (isCurrentAdmin()) { Object.values(globalUsers).forEach(u => { if(u.acc && u.acc !== "ADMIN") dlAcc.innerHTML += `<option value="${u.acc}">`; }); } else { dlAcc.innerHTML = `<option value="${_base(currentAccountName)}">`; } const dlDesc = document.getElementById('listDesc'); dlDesc.innerHTML = ''; const listaDescrizioni = ["NOTAIO NEXT", "FORMAZIONE NOTAIO NEXT", "PROGETTO VISIBILITA'", "NMW ESSENTIAL + E-SERVICES", "GDPR", "KLEOS", "APERTURA AREA GN NOTAIO NEXT", "UPGRADE E-FATTURA", "INTERVENTO FUORI CONTRATTO", "UTENTE AGGIUNTIVO NEXT", "UPGRADE M365 DA BASIC A STANDARD", "UTENTE AGGIUNTIVO SAAS", "NEXT CONNECTOR", "CORSO ONLINE ANTIRICICLAGGIO", "MICROSOFT 365 STANDARD", "CIS SUCCESSIONI", "KYC ANTIRICICLAGGIO", "OAPDF SUITE", "RINNOVO PATTO DIGITALE", "SPAZIO AGGIUNTIVO SAAS", "ATTO INFORMATICO", "KIT SERVIZIO ANTIRICICLAGGIO", "ARCHIVIAZIONE OTTICA", "UTENTE AGGIUNTIVO SUITE NOTARO C/S", "FALLITI PLUS", "UPGRADE DA ESSENTIAL A PRO", "SCRIPT IN KLEOS", "SUITE NOTARO NEW", "BUNDLE KYC - FALLITI GN", "AFFIANCAMENTO ATTO INFORMATICO", "INSTALLAZIONE SUITE NOTARO C/S", "ARGILLA IUS GN", "E-FATTURA GN", "FALLITI PLUS GN", "KYC ANTIRICLAGGIO GN", "NMW ESSENTIAL GN", "RICARICA KYC ANTIRICICLAGGIO", "UTENTE AGGIUNTIVO NEXT GN", "CORSO SUCCESSIONI TELEMATICHE", "ARGILLA IUS", "KYC ANTIRICLAGGIO", "UNIFICAZIONE AREA NEXT", "UPGRADE M365 DA BASIC A STANDARD GN", "KYC TITOLARE EFFETTIVO", "CONGUAGLIO CANONE NEXT", "FORMAZIONE SUITE NOTARO", "REINSTALLAZIONE SAE SU SERVER", "UTENTE AGGIUNTIVO KLEOS", "SUITE NOTARO SAAS", "IMPORT DATI", "MODULO SUCCESSIONI SUITE NOTARO", "UTENTE SUCCESSIONI NOTAIO NEXT", "IMPORT DATI NEXT", "CORSO PRATICHE CAMERALI", "UTENTE AGGIUNTIVO AFC", "ARCHIVIAZIONE POSTA IN LOCALE"]; listaDescrizioni.forEach(d => dlDesc.innerHTML += `<option value="${d}">`); const selSt = document.getElementById('ordStato'); selSt.innerHTML = ''; ["Evaso", "da evadere", "Sospeso", "Parziale"].forEach(s => selSt.innerHTML += `<option value="${s}">${s}</option>`); const dlCli = document.getElementById('clientListOptions'); dlCli.innerHTML = ''; clientiView.forEach(c => { if(c.SAP && c.Nome) dlCli.innerHTML += `<option value="${c.SAP || ''} - ${c.Nome || ''}">`; }); };

    function renderTabelle() { _initDrops(); const isAdmin = isCurrentAdmin(); const colConfigs = [{ label: "SAP", key: "SAP" }, { label: "Nome", key: "Nome" }, { label: "PIVA", key: "PIVA" }, { label: "Cod. Fiscale", key: "Codice_Fiscale" }, { label: "Account", key: "Account" }, { label: "Via", key: "Via_e_numero" }, { label: "Città", key: "Città" }, { label: "Prov", key: "Prov" }, { label: "Telefono", key: "Telefono" }, { label: "Email", key: "e_mail" }, { label: "Note", key: "Note" }]; let th = '<tr>'; if(isAdmin) th += '<th class="bg-secondary text-white">Az.</th>'; colConfigs.forEach((conf, index) => { th += `<th>${conf.label}<input type="text" class="header-filter" onkeyup="window.filterClienti(${index})"></th>`; }); th += '</tr>'; document.getElementById('theadClientiFull').innerHTML = th; let tbodyHtml = ''; clientiView.forEach(c => { tbodyHtml += '<tr>'; if(isAdmin) tbodyHtml += `<td style="white-space:nowrap;"><i class="bi bi-pencil-square text-primary me-2" style="cursor:pointer" onclick="window.openEditCliente('${c.firebaseKey}')"></i><i class="bi bi-trash text-danger" style="cursor:pointer" onclick="window.eliminaCliente('${c.firebaseKey}')"></i></td>`; colConfigs.forEach(conf => { let val = (conf.key === 'Codice_Fiscale') ? getCodiceFiscale(c) : (c[conf.key] ?? ''); tbodyHtml += `<td>${val}</td>`; }); tbodyHtml += '</tr>'; }); document.getElementById('tabellaClientiFull').innerHTML = tbodyHtml; const contractCols = ["ACCOUNT", "SAP", "NOME CLIENTE", "CODICE SISTEMA", "VALORE RINNOVO", "VAL. UNIT. MENS.", "TESTO ORDINE", "Q.tà", "PASSO", "DATA SCADENZA", "PAGAMENTO", "CODICE"]; let htmlConHead = '<tr>'; if(isAdmin) htmlConHead += '<th class="bg-secondary text-white">Az.</th>'; contractCols.forEach((colName, index) => { htmlConHead += `<th>${colName}<input type="text" class="header-filter" onkeyup="window.filterContratti(${index})"></th>`; }); htmlConHead += '</tr>'; document.getElementById('theadContrattiFull').innerHTML = htmlConHead; let htmlCon = ''; contrattiView.forEach(c => { const valMen = parseFloat(c.VAL_UN_MEN || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2}); let dataFmt = c.DATA_SCAD; if(c.DATA_SCAD) { const d = new Date(c.DATA_SCAD); if(!isNaN(d.getTime())) dataFmt = d.toLocaleDateString('it-IT'); } htmlCon += `<tr>`; if(isAdmin) htmlCon += `<td style="white-space:nowrap;"><i class="bi bi-pencil-square text-primary me-2" style="cursor:pointer" onclick="window.openEditContratto('${c.firebaseKey}')"></i><i class="bi bi-trash text-danger" style="cursor:pointer" onclick="window.eliminaContratto('${c.firebaseKey}')"></i></td>`; htmlCon += `<td>${c["Account"]||c["Agente_dell'ORDINE"]||''}</td><td>${c.SAP||''}</td><td>${c.Nome||''}</td><td>${c.Codice_SISTEMA||''}</td><td>${c.VALORE_RINNOVO||''}</td><td>${valMen}</td><td>${c.TESTO_ORD_||''}</td><td>${c["QUANTITA'"]||''}</td><td>${c.PASSO||''}</td><td>${dataFmt}</td><td>${c.Pagamento||''}</td><td>${c.CODICE||''}</td></tr>`; }); document.getElementById('tabellaContrattiFull').innerHTML = htmlCon; const tbFatt = document.getElementById('tabellaFatturatoFull'); tbFatt.innerHTML = ''; fatturatoView.forEach(ord => { let mesi = 0; if(ord.Data_prima_fatt) { const dt = new Date(ord.Data_prima_fatt); if(!isNaN(dt)) mesi = Math.max(0, Math.min(12, 13 - (dt.getMonth()+1))); } const wkiMese = parseFloat(ord.WKI_m || ord.Can_WKI_mese || 0); const m365Mese = parseFloat(ord.M365_m || ord.M365_mese || 0); const unaTantum = parseFloat(ord.Una_Tantum || 0); const wkiTot = wkiMese * mesi; const m365Tot = m365Mese * mesi; const finanziario = (wkiMese + m365Mese) * 12; const k = ord.firebaseKey; const checkedAttr = ord.isFatturato ? 'checked' : ''; tbFatt.innerHTML += `<tr><td style="white-space:nowrap;"><i class="bi bi-pencil-square text-primary me-2" style="cursor:pointer" onclick="window.openEditOrdine('${k}')"></i><i class="bi bi-trash text-danger" style="cursor:pointer" onclick="window.eliminaRigaFatturato('${k}')"></i></td><td contenteditable="true" class="editable-cell" onblur="window.salvaModificaCella(this,'${k}','Data_ordine')">${ord.Data_ordine||''}</td><td>${ord.SAP||''}</td><td>${ord.Cliente||''}</td><td contenteditable="true" class="editable-cell" onblur="window.salvaModificaCella(this,'${k}','Account')">${ord.Account||''}</td><td contenteditable="true" class="editable-cell fw-bold text-danger" onblur="window.salvaModificaCella(this,'${k}','Ordine_AP')">${ord.Ordine_AP||''}</td><td contenteditable="true" class="editable-cell" onblur="window.salvaModificaCella(this,'${k}','Descrizione_Ordine')">${ord.Descrizione_Ordine||''}</td><td contenteditable="true" class="editable-cell small" onblur="window.salvaModificaCella(this,'${k}','Note')">${ord.Note||''}</td><td contenteditable="true" class="editable-cell text-end" onblur="window.salvaModificaCella(this,'${k}','WKI_m')">${wkiMese}</td><td contenteditable="true" class="editable-cell text-end" onblur="window.salvaModificaCella(this,'${k}','M365_m')">${m365Mese}</td><td contenteditable="true" class="editable-cell text-end" data-val="${unaTantum}" onblur="window.salvaModificaCella(this,'${k}','Una_Tantum')">${unaTantum.toFixed(2)}</td><td contenteditable="true" class="editable-cell" onblur="window.salvaModificaCella(this,'${k}','Finanaziata')">${ord.Finanaziata||''}</td><td contenteditable="true" class="editable-cell" onblur="window.salvaModificaCella(this,'${k}','Stato')">${ord.Stato||''}</td><td class="text-center align-middle"><input type="checkbox" class="form-check-input border-secondary" ${checkedAttr} onchange="window.toggleFatturato(this, '${k}')" style="transform: scale(1.2);"></td><td contenteditable="true" class="editable-cell fw-bold" onblur="window.salvaModificaCella(this,'${k}','Data_prima_fatt')">${ord.Data_prima_fatt||''}</td><td class="bg-light text-center fw-bold">${mesi}</td><td class="bg-light text-end small" data-val="${finanziario}">${finanziario.toFixed(2)}</td><td class="bg-light text-end small" data-val="${wkiTot}">${wkiTot.toFixed(2)}</td><td class="bg-light text-end small" data-val="${m365Tot}">${m365Tot.toFixed(2)}</td></tr>`; }); window.updateFatturatoTotals(); renderTabellaMigrazioni(); }

    const usersRef = ref(db, 'users'); onValue(usersRef, (snap) => { document.getElementById('criticalErrorAlert').style.display = 'none'; globalUsers = snap.val() || {}; if(auth.currentUser) checkUserMapping(auth.currentUser); }, (error) => { console.error("Errore lettura Users:", error); document.getElementById('criticalErrorAlert').style.display = 'block'; });
    onValue(ref(db, '/'), (snap) => { const data = snap.val() || {}; globalClienti = data.clienti ? Object.entries(data.clienti).map(([k,v])=>({...v, firebaseKey: k})) : []; globalContratti = data.contratti ? Object.entries(data.contratti).map(([k,v])=>({...v, firebaseKey: k})) : []; globalFatturato = data.fatturato ? Object.entries(data.fatturato).map(([k,v])=>({...v, firebaseKey: k})) : []; globalMigrazioni = data.migrazioni ? Object.entries(data.migrazioni).map(([k,v])=>({...v, firebaseKey: k})) : []; document.getElementById('dbStatus').innerText = `Online: ${globalClienti.length} Cli, ${globalFatturato.length} Ord, ${globalMigrazioni.length} Migr.`; if (currentUserEmail) { rebuildVisibilityContext(); renderTabelle(); } });

</script>
</body>
</html>
